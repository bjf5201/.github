name: Check Transpiled JavaScript

on:
  workflow_call:
    inputs:
      dist-path:
        required: true
        description: 'Path to the dist/ directory to compare against.'
        type: string
        default: './dist/'
      node-version:
        required: false
        description: 'Node version file to use for the job.'
        type: string
        default: '.nvmrc'
      node-caching:
        required: false
        description: 'Cache node_modules between jobs. Leave blank to disable.'
        type: string
        default: 'pnpm'

jobs:
  check-dist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: pnpm setup
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0

      - name: Node setup
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Format & lint
        run: pnpm run lint && pnpm run format

      - name: Rebuild dist directory
        run: pnpm run tsc || pnpm run build

      # This will fail the workflow if the `dist/` directory is different than
      # expected.
      - name: Compare Directories
        id: diff
        run: |
          if [ ! -d dist/ ]; then
            echo "Expected dist/ directory does not exist.  See status below:"
            ls -la ./
            exit 1
          fi
          if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff --ignore-space-at-eol --text dist/
            exit 1
          fi

      # If `dist/` was different than expected, upload the expected version as a
      # workflow artifact.
      - if: ${{ failure() && steps.diff.outcome == 'failure' }}
        name: Upload Artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ${{ inputs.dist-path }}